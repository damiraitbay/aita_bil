// Переводы
const translations = {
    kk: {
        'meta.title': 'AitaBil | Ағылшын, қытай және түрік тілдерінің курстары',
        'nav.home': 'Басты',
        'nav.courses': 'Курстар',
        'nav.about': 'Біз туралы',
        'nav.teachers': 'Оқытушылар',
        'nav.contact': 'Байланыс',
        'nav.instagram': 'Instagram',
        'hero.title': 'әлемін ашыңыз',
        'hero.subtitle': 'Шетелдік және шетелде білім алған оқытушылармен ағылшын, қытай және түрік тілдерін үйрену',
        'hero.btn.course': 'Курс таңдау',
        'hero.btn.free': 'Тегін сабақ',
        'stats.students': 'оқушы',
        'stats.teachers': 'оқытушы',
        'stats.languages': 'тіл',
        'courses.title': 'Біздің курстар',
        'courses.subtitle': 'Меңгергіңіз келетін тілді таңдаңыз',
        'courses.english.title': 'Ағылшын',
        'courses.english.feature1': 'Сөйлеу практикасы',
        'courses.english.feature2': 'Іскерлік ағылшын',
        'courses.english.feature3': 'Емтиханға дайындық',
        'courses.english.price': '60 000 теңге/ай бастап',
        'courses.chinese.title': 'Қытай',
        'courses.chinese.feature1': 'Қытайға оқуға түсу',
        'courses.chinese.feature2': 'Қытаймен бизнес жасау',
        'courses.chinese.feature3': 'Қытай мәдениеті',
        'courses.chinese.price': '60 000 теңге/ай бастап',
        'courses.turkish.title': 'Түрік',
        'courses.turkish.feature1': 'Аудармашысыз саяхаттау',
        'courses.turkish.feature2': 'Түркиямен бизнес жасау',
        'courses.turkish.feature3': 'Түркияға оқуға түсу',
        'courses.turkish.price': '60 000 теңге/ай бастап',
        'courses.btn.choose': 'Таңдау',
        'courses.level.beginner': 'A1-A2',
        'courses.level.intermediate': 'B1-B2',
        'courses.level.advanced': 'TOMER',
        'about.title': 'Неге бізді таңдайды?',
        'about.feature1.title': 'Шетелдік және шетелде білім алған оқытушылар',
        'about.feature1.desc': 'Шетелде білім алған оқытушылармен ағылшын, қытай және түрік тілдерін үйрену',
        'about.feature2.title': 'Оффлайн/Онлайн формат',
        'about.feature2.desc': 'Әлемнің кез келген жерінен ыңғайлы уақытта оқыңыз',
        'about.feature3.title': 'Сөйлеу клубтары',
        'about.feature3.desc': 'Апта сайын ана тіліндегі оқытушылармен практика',
        'about.feature4.title': 'Ойын әдістемесі',
        'about.feature4.desc': 'Жақсы есте сақтау үшін интерактивті тапсырмалар мен викториналар',
        'teachers.title': 'Біздің оқытушылар',
        'teachers.subtitle': 'Халықаралық сертификаттары бар мамандар',
        'teachers.english.lang': 'Ағылшын тілі',
        'teachers.english.bio': 'Лондоннан ана тіліндегі оқытушы, CELTA сертификаты, 8 жыл оқыту тәжірибесі',
        'teachers.chinese.lang': 'Қытай тілі',
        'teachers.chinese.bio': '西安外国语大学 (Xi\'an International Studies University) университетінде қытай тілін үйрену курсын тамамдаған. 天津职业技术师范大学 (Tianjin University of Technology and Education) университетінде магистр дәрежесін қорғаған',
        'teachers.turkish.lang': 'Түрік тілі',
        'teachers.turkish.bio': 'Түркия азаматы, Erciyes Üniversitesi жоғарғы оқу орнында бакалавр дәрежесін қорғаған',
        'contact.title': 'Сынақ сабағына жазылыңыз',
        'contact.subtitle': 'Алғашқы сабақ — тегін!',
        'contact.select.language': 'Тілді таңдаңыз',
        'contact.select.english': 'Ағылшын',
        'contact.select.chinese': 'Қытай',
        'contact.select.turkish': 'Түрік',
        'contact.select.course': 'Курсты таңдаңыз',
        'contact.select.economy': 'Economy - 20 000 теңге (топта 5-6 оқушы)',
        'contact.select.standart': 'Standart - 25 000 теңге (топта 4 оқушы)',
        'contact.select.trio': 'Trio - 30 000 теңге (топта 3 оқушы)',
        'contact.select.duo': 'Duo - 40 000 теңге (топта 2 оқушы)',
        'contact.select.individual': 'Individual - 60 000 теңге (1 оқушы)',
        'contact.btn.submit': 'Сынақ сабағына жазылу',
        'contact.note': 'Біз 24 сағат ішінде сізбен байланысамыз',
        'contact.info.title': 'Бізбен байланысыңыз',
        'footer.tagline': 'Бізбен бірге тілдер әлемін ашыңыз',
        'footer.copyright': '© 2024 AitaBil. Барлық құқықтар қорғалған.',
        'modal.title': 'Өтінішіңізге рахмет!',
        'modal.message': 'Біз сіздің сынақ сабағына өтінішіңізді алдық. Біздің менеджер 24 сағат ішінде сізбен байланысады.',
        'modal.instagram': 'Ал пайдалы материалдар үшін біздің <a href="https://instagram.com/ваш_instagram" target="_blank" class="instagram-link">Instagram</a>-ға жазылыңыз!'
    },
    ru: {
        'meta.title': 'AitaBil | Курсы английского, китайского и турецкого языков',
        'nav.home': 'Главная',
        'nav.courses': 'Курсы',
        'nav.about': 'О нас',
        'nav.teachers': 'Преподаватели',
        'nav.contact': 'Контакты',
        'nav.instagram': 'Instagram',
        'hero.title': 'Откройте мир',
        'hero.subtitle': 'Изучение английского, китайского и турецкого языков с иностранными и получившими образование за рубежом преподавателями',
        'hero.btn.course': 'Выбрать курс',
        'hero.btn.free': 'Бесплатный урок',
        'stats.students': 'учеников',
        'stats.teachers': 'преподавателей',
        'stats.languages': 'языка',
        'courses.title': 'Наши курсы',
        'courses.subtitle': 'Выберите язык, который хотите освоить',
        'courses.english.title': 'Английский',
        'courses.english.feature1': 'Разговорная практика',
        'courses.english.feature2': 'Деловой английский',
        'courses.english.feature3': 'Подготовка к экзаменам',
        'courses.english.price': 'от 60 000 тенге/мес',
        'courses.chinese.title': 'Китайский',
        'courses.chinese.feature1': 'Учеба в Китае',
        'courses.chinese.feature2': 'Бизнес с Китаем',
        'courses.chinese.feature3': 'Культура Китая',
        'courses.chinese.price': 'от 60 000 тенге/мес',
        'courses.turkish.title': 'Турецкий',
        'courses.turkish.feature1': 'Путешествие без переводчика',
        'courses.turkish.feature2': 'Бизнес с Турцией',
        'courses.turkish.feature3': 'Учеба в Турции',
        'courses.turkish.price': 'от 60 000 тенге/мес',
        'courses.btn.choose': 'Выбрать',
        'courses.level.beginner': 'A1-A2',
        'courses.level.intermediate': 'B1-B2',
        'courses.level.advanced': 'TOMER',
        'about.title': 'Почему выбирают нас?',
        'about.feature1.title': 'Иностранные и получившие образование за рубежом преподаватели',
        'about.feature1.desc': 'Изучение английского, китайского и турецкого языков с преподавателями, получившими образование за рубежом',
        'about.feature2.title': 'Оффлайн/Онлайн формат',
        'about.feature2.desc': 'Занимайтесь из любой точки мира в удобное время',
        'about.feature3.title': 'Разговорные клубы',
        'about.feature3.desc': 'Практика общения с носителями каждую неделю',
        'about.feature4.title': 'Игровая методика',
        'about.feature4.desc': 'Интерактивные задания и квизы для лучшего запоминания',
        'teachers.title': 'Наши преподаватели',
        'teachers.subtitle': 'Профессионалы с международными сертификатами',
        'teachers.english.lang': 'Английский язык',
        'teachers.english.bio': 'Носитель языка из Лондона, сертификат CELTA, 8 лет преподавания',
        'teachers.chinese.lang': 'Китайский язык',
        'teachers.chinese.bio': 'Завершил курс изучения китайского языка в университете 西安外国语大学 (Xi\'an International Studies University). Защитил степень магистра в университете 天津职业技术师范大学 (Tianjin University of Technology and Education)',
        'teachers.turkish.lang': 'Турецкий язык',
        'teachers.turkish.bio': 'Гражданка Турции, защитила степень бакалавра в высшем учебном заведении Erciyes Üniversitesi',
        'contact.title': 'Запишитесь на пробный урок',
        'contact.subtitle': 'Первый урок — бесплатно!',
        'contact.select.language': 'Выберите язык',
        'contact.select.english': 'Английский',
        'contact.select.chinese': 'Китайский',
        'contact.select.turkish': 'Турецкий',
        'contact.select.course': 'Выберите курс',
        'contact.select.economy': 'Economy - 20 000 тенге (в группе 5-6 учеников)',
        'contact.select.standart': 'Standart - 25 000 тенге (в группе 4 ученика)',
        'contact.select.trio': 'Trio - 30 000 тенге (в группе 3 ученика)',
        'contact.select.duo': 'Duo - 40 000 тенге (в группе 2 ученика)',
        'contact.select.individual': 'Individual - 60 000 тенге (1 ученик)',
        'contact.btn.submit': 'Записаться на пробный урок',
        'contact.note': 'Мы свяжемся с вами в течение 24 часов',
        'contact.info.title': 'Свяжитесь с нами',
        'footer.tagline': 'Откройте мир языков вместе с нами',
        'footer.copyright': '© 2024 AitaBil. Все права защищены.',
        'modal.title': 'Спасибо за заявку!',
        'modal.message': 'Мы получили вашу заявку на пробный урок. Наш менеджер свяжется с вами в течение 24 часов.',
        'modal.instagram': 'А пока подпишитесь на наш <a href="https://instagram.com/ваш_instagram" target="_blank" class="instagram-link">Instagram</a> для полезных материалов!'
    }
};

// Текущий язык (по умолчанию казахский)
let currentLang = localStorage.getItem('language') || 'kk';

// Функция переключения языка
function switchLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('language', lang);
    document.documentElement.lang = lang;

    // Обновляем активную кнопку языка
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-lang') === lang) {
            btn.classList.add('active');
        }
    });

    // Обновляем все тексты с data-translate
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) {
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                element.placeholder = translations[lang][key];
            } else if (element.tagName === 'OPTION') {
                // Сохраняем выбранное значение перед обновлением
                const select = element.parentElement;
                const wasSelected = element.selected;
                element.textContent = translations[lang][key];
                if (wasSelected) {
                    element.selected = true;
                }
            } else if (element.tagName === 'TITLE') {
                document.title = translations[lang][key];
            } else {
                // Для элементов с HTML контентом (например, modal.instagram)
                if (key === 'modal.instagram') {
                    element.innerHTML = translations[lang][key];
                } else {
                    element.textContent = translations[lang][key];
                }
            }
        }
    });

    // Обновляем placeholder для input полей
    document.querySelectorAll('input[data-placeholder-kk]').forEach(input => {
        if (lang === 'kk') {
            input.placeholder = input.getAttribute('data-placeholder-kk');
        } else {
            input.placeholder = input.getAttribute('data-placeholder-ru');
        }
    });

    // Обновляем title страницы
    const titleElement = document.querySelector('title[data-translate]');
    if (titleElement) {
        document.title = translations[lang]['meta.title'];
    }

    // Показываем/скрываем правильные элементы typing effect и устанавливаем порядок
    const typingKk = document.querySelector('.hero-typing-kk');
    const typingRu = document.querySelector('.hero-typing-ru');
    const titleText = document.querySelector('.hero-title-text');

    if (lang === 'kk') {
        if (typingKk) {
            typingKk.style.display = 'inline';
            typingKk.style.order = '1';
        }
        if (typingRu) typingRu.style.display = 'none';
        if (titleText) titleText.style.order = '2';
    } else {
        if (typingKk) typingKk.style.display = 'none';
        if (typingRu) {
            typingRu.style.display = 'inline';
            typingRu.style.order = '2';
        }
        if (titleText) titleText.style.order = '1';
    }

    // Обновляем typing effect
    initTypingEffect();
}

// Инициализация переключателя языков
function initLanguageSwitcher() {
    const langButtons = document.querySelectorAll('.lang-btn');

    langButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            switchLanguage(lang);
        });
    });

    // Инициализируем видимость элементов typing effect
    const typingKk = document.querySelector('.hero-typing-kk');
    const typingRu = document.querySelector('.hero-typing-ru');
    if (typingKk) typingKk.style.display = currentLang === 'kk' ? 'inline' : 'none';
    if (typingRu) typingRu.style.display = currentLang === 'ru' ? 'inline' : 'none';

    // Применяем сохраненный язык при загрузке
    switchLanguage(currentLang);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация всех компонентов
    initLanguageSwitcher();
    initNavbar();
    initTypingEffect();
    initScrollAnimations();
    // initCounters(); // Отключено - статистика не обновляется
    initCourseButtons();
    initContactForm();
    initScrollToTop();
    initModal();
});

// Навигационное меню
function initNavbar() {
    const menuToggle = document.getElementById('menuToggle');
    const navMenu = document.getElementById('navMenu');
    const navLinks = document.querySelectorAll('.nav-link');

    menuToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
        menuToggle.innerHTML = navMenu.classList.contains('active') ?
            '<i class="fas fa-times"></i>' :
            '<i class="fas fa-bars"></i>';
    });

    // Функция для обновления активной ссылки
    function setActiveLink(targetId) {
        navLinks.forEach(link => {
            link.classList.remove('active');
            const href = link.getAttribute('href');
            if (href === `#${targetId}` || (targetId === 'home' && href === '#home')) {
                link.classList.add('active');
            }
        });
    }

    // Обработчик клика на ссылки
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            if (href.startsWith('#')) {
                e.preventDefault();
                const targetId = href.substring(1);
                setActiveLink(targetId);

                // Плавная прокрутка к секции
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }

            // Закрываем мобильное меню
            navMenu.classList.remove('active');
            menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
        });
    });

    // Обновление активной ссылки при скролле
    function updateActiveLinkOnScroll() {
        const sections = document.querySelectorAll('section[id]');
        const scrollPos = window.scrollY + 100; // Небольшой отступ

        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.offsetHeight;
            const sectionId = section.getAttribute('id');

            if (scrollPos >= sectionTop && scrollPos < sectionTop + sectionHeight) {
                setActiveLink(sectionId);
            }
        });

        // Проверка для hero секции (home)
        if (window.scrollY < 100) {
            setActiveLink('home');
        }
    }

    // Обработчик скролла
    window.addEventListener('scroll', updateActiveLinkOnScroll);
    updateActiveLinkOnScroll(); // Инициализация при загрузке
}

// Эффект печатающегося текста
let typingInterval = null;

function initTypingEffect() {
    // Выбираем правильный typing-text элемент в зависимости от языка
    const typingText = currentLang === 'kk' ?
        document.querySelector('.hero-typing-kk') :
        document.querySelector('.hero-typing-ru');
    if (!typingText) return;

    // Останавливаем предыдущий интервал, если он есть
    if (typingInterval) {
        clearTimeout(typingInterval);
    }

    // Получаем слова в зависимости от текущего языка
    const wordsAttr = currentLang === 'kk' ? 'data-words-kk' : 'data-words-ru';
    let wordsStr = typingText.getAttribute(wordsAttr) || (currentLang === 'kk' ? '["Ағылшын тілі", "Қытай тілі", "Түрік тілі"]' : '["английского языка", "китайского языка", "турецкого языка"]');
    // Декодируем HTML-сущности если они есть
    if (wordsStr.includes('&quot;')) {
        wordsStr = wordsStr.replace(/&quot;/g, '"');
    }
    const words = JSON.parse(wordsStr);

    let wordIndex = 0;
    let charIndex = 0;
    let isDeleting = false;

    function type() {
        const currentWord = words[wordIndex];

        if (isDeleting) {
            typingText.textContent = currentWord.substring(0, charIndex - 1);
            charIndex--;
        } else {
            typingText.textContent = currentWord.substring(0, charIndex + 1);
            charIndex++;
        }

        if (!isDeleting && charIndex === currentWord.length) {
            isDeleting = true;
            typingInterval = setTimeout(type, 1500);
        } else if (isDeleting && charIndex === 0) {
            isDeleting = false;
            wordIndex = (wordIndex + 1) % words.length;
            typingInterval = setTimeout(type, 500);
        } else {
            typingInterval = setTimeout(type, isDeleting ? 50 : 100);
        }
    }

    typingInterval = setTimeout(type, 1000);
}

// Анимации при скролле
function initScrollAnimations() {
    const animatedElements = document.querySelectorAll('.animate-on-scroll');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animated');
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    });

    animatedElements.forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(30px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
    });
}

// Анимированные счетчики
function initCounters() {
    const counters = document.querySelectorAll('.stat-number');
    const speed = 200;

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                counters.forEach(counter => {
                    const target = +counter.getAttribute('data-count');
                    const count = +counter.innerText;
                    const increment = target / speed;

                    if (count < target) {
                        counter.innerText = Math.ceil(count + increment);
                        setTimeout(() => {
                            const event = new CustomEvent('count');
                            counter.dispatchEvent(event);
                        }, 1);
                    } else {
                        counter.innerText = target;
                    }
                });
            }
        });
    }, { threshold: 0.5 });

    observer.observe(document.querySelector('.hero-stats'));
}

// Кнопки выбора курса
function initCourseButtons() {
    const courseButtons = document.querySelectorAll('.course-btn');

    courseButtons.forEach(button => {
        button.addEventListener('click', function() {
            const course = this.getAttribute('data-course');
            document.getElementById('language').value = course.toLowerCase();
            document.getElementById('contact').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            // Анимация кнопки
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    });
}

// Форма обратной связи
function initContactForm() {
    const form = document.getElementById('lessonForm');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Получаем данные формы
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const languageSelect = document.getElementById('language');
        const languageText = languageSelect.options[languageSelect.selectedIndex].text;
        const courseSelect = document.getElementById('course');
        const courseValue = courseSelect.value;

        // Маппинг названий тарифов для отправки (только название, без описания и цены)
        const courseNames = {
            kk: {
                'economy': 'Economy',
                'standart': 'Standart',
                'trio': 'Trio',
                'duo': 'Duo',
                'individual': 'Individual'
            },
            ru: {
                'economy': 'Economy',
                'standart': 'Standart',
                'trio': 'Trio',
                'duo': 'Duo',
                'individual': 'Individual'
            }
        };

        const courseName = courseNames[currentLang][courseValue] || courseValue;

        // Формируем сообщение в зависимости от языка интерфейса
        let message = '';
        if (currentLang === 'kk') {
            message = `Сәлеметсіз бе! Мен сынақ сабағына жазылғым келеді.\n\n` +
                `Аты: ${name}\n` +
                `Телефон: ${phone}\n` +
                `Тіл: ${languageText}\n` +
                `Курс: ${courseName}`;
        } else {
            message = `Здравствуйте! Я хочу записаться на пробный урок.\n\n` +
                `Имя: ${name}\n` +
                `Телефон: ${phone}\n` +
                `Язык: ${languageText}\n` +
                `Курс: ${courseName}`;
        }

        // Номер WhatsApp (без + и пробелов)
        const whatsappNumber = '77056586393';

        // Формируем URL для WhatsApp
        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

        // Анимация отправки
        const submitBtn = form.querySelector('button[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const originalText = btnText.textContent;
        btnText.textContent = currentLang === 'kk' ? 'Жіберілуде...' : 'Отправка...';
        submitBtn.disabled = true;

        // Открываем WhatsApp
        setTimeout(() => {
            // Открываем WhatsApp в новой вкладке
            window.open(whatsappUrl, '_blank');

            // Показываем модальное окно
            document.getElementById('successModal').classList.add('active');

            // Сбрасываем форму
            form.reset();

            // Восстанавливаем кнопку
            btnText.textContent = originalText;
            submitBtn.disabled = false;
        }, 500);
    });
}

// Кнопка "Наверх"
function initScrollToTop() {
    const scrollBtn = document.getElementById('scrollToTop');

    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            scrollBtn.classList.add('visible');
        } else {
            scrollBtn.classList.remove('visible');
        }
    });

    scrollBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

// Модальное окно
function initModal() {
    const modal = document.getElementById('successModal');
    const closeBtn = modal.querySelector('.modal-close');

    closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
    });

    // Закрытие по клику вне окна
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });

    // Закрытие по ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            modal.classList.remove('active');
        }
    });
}

// Дополнительные интерактивные эффекты
document.addEventListener('DOMContentLoaded', function() {
    // Эффект параллакса для hero секции
    window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset;
        const hero = document.querySelector('.hero');
        if (hero) {
            const rate = scrolled * -0.5;
            hero.style.backgroundPosition = `0px ${rate}px`;
        }
    });

    // Добавляем hover-эффекты для карточек курсов
    const courseCards = document.querySelectorAll('.course-card');
    courseCards.forEach(card => {
        card.addEventListener('mouseenter', () => {
            card.style.zIndex = '10';
        });

        card.addEventListener('mouseleave', () => {
            card.style.zIndex = '1';
        });
    });

    // Анимация иконок в преимуществах
    const featureIcons = document.querySelectorAll('.feature-icon');
    featureIcons.forEach(icon => {
        icon.addEventListener('mouseenter', () => {
            icon.style.transform = 'rotate(15deg) scale(1.1)';
        });

        icon.addEventListener('mouseleave', () => {
            icon.style.transform = 'rotate(0) scale(1)';
        });
    });
});